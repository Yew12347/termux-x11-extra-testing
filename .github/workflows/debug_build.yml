name: Build

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'img/**'
  pull_request:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'img/**'
  workflow_dispatch:

jobs:
  build:
    name: "Build"
    runs-on: ubuntu-22.04   # IMPORTANT: not ubuntu-latest (newer breaks stuff)

    steps:
    # -------------------- CHECKOUT --------------------
    - name: Clone repository
      uses: actions/checkout@v5
      with:
        submodules: recursive
        fetch-depth: 1

    # -------------------- JAVA --------------------
    - name: Java setup
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '17'

    # -------------------- FORCE OLD GRADLE --------------------
    - name: Setup Gradle 7.6
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 7.6

    # ‚ùå REMOVE wrapper validation (it breaks old projects)
    # - name: Validation
    #   uses: gradle/actions/wrapper-validation@v4

    # -------------------- ANDROID SDK --------------------
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # -------------------- INSTALL NDK + CMAKE --------------------
    - name: Install Android packages (NDK + CMake)
      env:
        ANDROID_SDK_ROOT: ${{ env.ANDROID_HOME }}
      run: |
        yes | sdkmanager --licenses

        sdkmanager \
          "platform-tools" \
          "platforms;android-34" \
          "build-tools;34.0.0" \
          "ndk;26.1.10909125" \
          "cmake;3.22.1"

    # -------------------- CACHE --------------------
    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # -------------------- BUILD --------------------
    - name: Build
      env:
        ANDROID_NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/26.1.10909125
      run: |
        ./gradlew --version
        ./gradlew assembleDebug --stacktrace --no-daemon

    # -------------------- COMPANION PACKAGE --------------------
    - name: Build companion package
      run: ./build_termux_package

    # -------------------- UPLOAD APKs --------------------
    - name: Store app-arm64-v8a-debug
      uses: actions/upload-artifact@v4
      with:
        name: termux-x11-arm64-v8a-debug
        path: ./app/build/outputs/apk/debug/app-arm64-v8a-debug.apk
    
    - name: Store app-armeabi-v7a-debug
      uses: actions/upload-artifact@v4
      with:
        name: termux-x11-armeabi-v7a-debug
        path: ./app/build/outputs/apk/debug/app-armeabi-v7a-debug.apk
    
    - name: Store app-universal-debug
      uses: actions/upload-artifact@v4
      with:
        name: termux-x11-universal-debug
        path: ./app/build/outputs/apk/debug/app-universal-debug.apk
    
    - name: Store app-x86_64-debug
      uses: actions/upload-artifact@v4
      with:
        name: termux-x11-x86_64-debug
        path: ./app/build/outputs/apk/debug/app-x86_64-debug.apk
    
    - name: Store app-x86-debug
      uses: actions/upload-artifact@v4
      with:
        name: termux-x11-x86-debug
        path: ./app/build/outputs/apk/debug/app-x86-debug.apk

    # -------------------- UPLOAD COMPANION PACKAGES --------------------
    - name: Store companion package
      uses: actions/upload-artifact@v4
      with:
        name: termux-companion-packages
        path: |
          ./app/build/outputs/apk/debug/termux-x11-*-all.deb
          ./app/build/outputs/apk/debug/termux-x11-*-any.pkg.tar.xz
